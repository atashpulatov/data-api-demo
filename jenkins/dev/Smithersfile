job 'stage-1-dev' do
  description 'the first stage in the pipeline
designed to complete quickly, < 10 mins
produces and publishes a versioned deployment package'

  configure_common_items{}

  assigned_node_string 'amazon_linux'
  
   build_wrappers do
    secret_text do
      credentialsId 'Tools'
      variable 'SRCCLR_API_TOKEN'
    end
  end

  builders do
    bash do
      script '#!/usr/bin/env bash
set +xe

export PATH=/usr/local/sbin:/usr/local/bin:$PATH

export WORKSPACE_SETTING=aws_dev

source .ecosystem
rake count_line_of_code
export HATS=$HATS:rallytask
rake pre_pipeline
rake veracode
rake upload_plugins 
 
#rake update_dep_db_from_file
rake update_ready_for_pr

rake post_pipeline
'
    end

    sonarqube do
      other_properties 'sonar.javascript.lcov.reportPaths=production/coverage/lcov.info
                        sonar.exclusions=**/_tests_/*,**/*.test.*
                        sonar.coverage.exclusions=**/public/*'
    end
  end

  publishers do
    parameterized_trigger do
      job_short_names %w{
        stage-2-e2e-browser-test-mac
        stage-2-e2e-client-test-win-pre
        stage-2-e2e-browser-test-python-mac
        stage-2-e2e-desktop-test-python-mac
      }
    end
    ext_mailer do
     recipients_list 'la-oficina-para-dev-d-aaaacnxgbmsvk55vean2hciclq@microstrategy.slack.com,broken-build-gdc-aaaaetzcjbfbaqe4n7xaeu7ttm@microstrategy.slack.com'
     subject 'mstr-office stage-1 - $BUILD_STATUS'
     content '$DEFAULT_CONTENT'
     fail_trigger_notify_developer 'true'
     always_trigger 'false'
    end
  end

end 
 
