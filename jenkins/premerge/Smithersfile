job 'stage-0-premerge' do
  description 'the first stage in the pipeline
designed to complete quickly, < 10 mins
produces and publishes a versioned deployment package'

  configure_common_items{}

  assigned_node_string 'amazon_linux'

  triggers do
      pull_request_builder do
        trigger_phrase "#{Environment.project_name}-premerge-#{Environment.branch_name}.*"
        commit_status_context "#{Environment.project_name}-premerge-#{Environment.branch_name}"
      end
  end
  
  build_wrappers do
   secret_text do
     credentialsId 'Tools'
     variable 'SRCCLR_API_TOKEN'
    end
  end

  builders do
    bash do
      script '#!/usr/bin/env bash
set +xe

export PATH=/usr/local/sbin:/usr/local/bin:$PATH

export WORKSPACE_SETTING=aws_dev

source .ecosystem
rake pre_pipeline
rake veracode

rake stage_0_test

rake post_pipeline
'
    end

    sonarqube do
      other_properties 'sonar.javascript.lcov.reportPaths=production/coverage/lcov.info
                        sonar.exclusions=**/_tests_/*,**/*.test.*
                        sonar.coverage.exclusions=**/public/*'
    end
  end

  publishers do
    html do
      report_name 'Code Coverage Report'
      report_directory_path ".comparison_report"
      index_file_name 'index.html'
    end
    html do
      report_name 'eslint report'
      report_directory_path "production/coverage"
      index_file_name 'eslint.html'
    end

    ext_mailer do
      recipients_list '$ghprbActualCommitAuthorEmail $ghprbPullAuthorEmail'
      subject 'mstr-office pre merge - $BUILD_STATUS'
      content '$DEFAULT_CONTENT'
      fail_trigger_recipients_list ''
      fail_trigger_notify_developer 'true'
      always_trigger 'true'
      always_trigger_recipients_list ''
    end
  end

end

